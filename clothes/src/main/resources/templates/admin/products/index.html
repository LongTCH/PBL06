<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      lang=""
      layout:decorate="~{layouts/admin/layout}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products</title>
</head>
<body>
<section layout:fragment="body">
    <div style="background-color: #d5f8c4" class="d-flex justify-content-between align-items-center p-2">
        <h3 style="color: #214c0d; margin-left: 20px; margin-bottom: 0">Quản lý sản phẩm</h3>
        <div>
            <button class="btn btn-success">
                <i class="fas fa-plus-circle fa-lg"></i>
                Thêm sản phẩm
            </button>
        </div>
    </div>
    <div class="d-flex justify-content-between align-items-center mt-3">
        <div class="filter-options">
            <label for="categoryFilter">Lọc theo danh mục:</label>
            <select id="categoryFilter" name="categoryId" class="form-control form-control-sm"
                    th:onchange="filterProducts()">
                <option th:value="all" th:selected="${categoryId == 'all'}">Tất cả</option>
                <option th:each="category : ${categories}"
                        th:value="${category.getId()}"
                        th:text="${category.getName()}"
                        th:selected="${categoryId.equals(category.getId())}">
                </option>
            </select>
        </div>
        <div class="search-bar position-relative">
            <input class="form-control" type="search" name="keyword" th:value="${keyword}"
                   placeholder="Tìm theo tiêu đề ..."
                   id="keyword"
                   onkeypress="handleKeyPress(event)"
                   aria-label="Search" style="width: 400px;">
            <button class="btn btn-success position-absolute" type="submit" style="right: 0; top: 0; height: 100%;"
                    onclick="searchProduct()">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </div>
    <div class="mt-3">
        <table class="table table-bordered">
            <thead class="thead-dark">
            <tr>
                <th>ID</th>
                <th>Hình ảnh</th>
                <th>Tên sản phẩm</th>
                <th>Danh mục</th>
                <th>Giá</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
            </tr>
            </thead>
            <tbody>
            <tr th:if="${#lists.isEmpty(products)}">
                <td colspan="6" class="text-center">Không có sản phẩm</td>
            </tr>
            <tr th:each="product : ${products}">
                <td th:text="${product.getId()}"></td>
                <td><img th:src="${product.images[0].url}" alt="Product Image" style="width: 100px; height: auto;"></td>
                <td th:text="${product.title}"></td>
                <td th:if="${categoryNames.containsKey(product.categoryId)}"
                    th:text="${categoryNames[product.categoryId]}"></td>
                <td th:unless="${categoryNames.containsKey(product.categoryId)}">Không có danh mục</td>
                <td th:text="${product.variants[0].price} + 'đ'">100,000 VNĐ</td>
                <td th:text="${product.available ? 'Còn hàng' : 'Hết hàng'}"></td>
                <td>
                    <button class="btn btn-success btn-sm mb-2">Xem</button>
                    <button class="btn btn-warning btn-sm mb-2">Sửa</button>
                    <button class="btn btn-danger btn-sm">Xóa</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="row">
        <div class="col-sm-12 col-md-7">
            <div class="dataTables_paginate paging_simple_numbers" id="dataTable_paginate">
                <ul class="pagination">
                    <!-- Previous Button -->
                    <li class="paginate_button page-item previous"
                        th:classappend="${currentPage == 1} ? 'disabled' : ''" id="dataTable_previous">
                        <a th:if="${currentPage > 1}"
                           th:href="@{/admin/products( page=${currentPage - 1}, size=${size}, categoryId=${categoryId} )}"
                           aria-controls="dataTable" data-dt-idx="0" tabindex="0" class="page-link">Previous</a>
                        <span th:unless="${currentPage > 1}" class="page-link">Previous</span>
                    </li>
                    <!-- Page Number Buttons -->
                    <li th:if="${pagination.totalPages > 0}"
                        th:each="i : ${#numbers.sequence(1, pagination.getTotalPages())}"
                        class="paginate_button page-item"
                        th:classappend="${i == currentPage} ? 'active' : ''">
                        <a th:href="@{/admin/products( page=${i}, size=${size}, categoryId=${categoryId})}"
                           aria-controls="dataTable"
                           data-dt-idx="${i}"
                           tabindex="0"
                           class="page-link"
                           th:text="${i}"></a>
                    </li>

                    <!-- Next Button -->
                    <li class="paginate_button page-item next"
                        th:classappend="${currentPage >= pagination.getTotalPages()} ? 'disabled' : ''"
                        id="dataTable_next">
                        <a th:if="${currentPage < pagination.getTotalPages()}"
                           th:href="@{/admin/products(page=${currentPage + 1}, size=${size}, categoryId=${categoryId})}"
                           aria-controls="dataTable" data-dt-idx="2" tabindex="0" class="page-link">Next</a>
                        <span th:unless="${currentPage < pagination.getTotalPages()}"
                              class="page-link">Next</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        function filterProducts() {
            const categoryId = document.getElementById('categoryFilter').value;
            const size = 48;
            const currentPage = 1;
            window.location.href = `/admin/products?page=${currentPage}&size=${size}&categoryId=${categoryId}`;
        }

        function searchProduct() {
            const keyword = document.getElementById('keyword').value;
            const categoryId = document.getElementById('categoryFilter').value;
            const size = 48;
            const currentPage = 1;
            window.location.href = `/admin/products?page=${currentPage}&size=${size}&categoryId=${categoryId}&keyword=${keyword}`;
        }

        function handleKeyPress(event) {
            if (event.key === "Enter") {
                searchProduct();
            }
        }
    </script>
</section>
</body>
</html>
