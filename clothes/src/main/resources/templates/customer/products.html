<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org"
      lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous"/>
</head>
<body>
<div>
  <!-- Header -->
  <div th:replace="~{layouts/customer/header}"></div>


  <div layout:fragment="body">
    <div class="container mt-5">
      <div th:fragment="productsFragment" class="row mx-5" id="productsContainer">

          <div class="col-md-3 mb-4 product" th:each="product : ${products}">
            <div th:replace="~{components/product-card :: product-card(product=${product})}"></div>
          </div>

      </div>
    </div>
  </div>

  <!-- Footer -->
  <div th:replace="~{layouts/customer/footer}"></div>
</div>

<script>
  let page = 0;
  const size = 24;
  let isLoading = false;

  function loadMoreProducts() {
    if (isLoading) return;
    isLoading = true;

    page++;
    fetch(`/products?page=${page}&size=${size}`)
            .then(response => response.text())
            .then(html => {

              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = html;

              const products = tempDiv.querySelectorAll('.product');
              products.forEach(product => {
                document.getElementById('productsContainer').appendChild(product);
              });

              if (products.length === 0) {
                window.removeEventListener('scroll', loadMoreProducts);
              }

              isLoading = false;
            })
            .catch(() => isLoading = false);
  }

  window.addEventListener('scroll', function () {
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
      loadMoreProducts();
    }
  });
</script>
</body>
</html>
